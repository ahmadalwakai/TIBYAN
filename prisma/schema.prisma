// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  schemas   = ["public", "students", "teachers", "admins", "ai"]
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String
  password      String
  role          Role     @default(STUDENT)
  status        UserStatus @default(ACTIVE)
  emailVerified Boolean  @default(false)
  avatar        String?
  bio           String?
  notificationPrefs Json?
  membershipStatus MembershipStatus @default(ACTIVE)
  membershipPlan   String?
  membershipExpiresAt DateTime?
  membershipPerks  Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastActiveAt  DateTime @default(now())
  
  // Relations
  coursesCreated Course[] @relation("CourseInstructor")
  enrollments    Enrollment[]
  reviews        Review[]
  payments       Payment[]
  verificationTokens VerificationToken[]
  auditLogs      AuditLog[] @relation("AuditLogActor")
  certificates   Certificate[]
  blogPosts      BlogPost[]
  memberResources MemberResource[]
  memberSupportTickets MemberSupportTicket[]
  
  @@map("users")
  @@schema("public")
}

model VerificationToken {
  id        String   @id @default(cuid())
  token     String   @unique
  purpose   TokenPurpose
  userId    String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())
  
  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([token])
  @@index([userId])
  @@map("verification_tokens")
  @@schema("public")
}

enum TokenPurpose {
  EMAIL_VERIFICATION
  PASSWORD_RESET
  TEACHER_CONFIRMATION
  
  @@schema("public")
}

model EmailVerificationCode {
  id        String   @id @default(cuid())
  email     String
  code      String   @unique
  purpose   VerificationCodePurpose @default(ADMIN_LOGIN)
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())
  
  @@index([email])
  @@index([code])
  @@map("email_verification_codes")
  @@schema("public")
}

enum MemberResourceType {
  LINK
  DOCUMENT
  ARTICLE

  @@schema("public")
}

model MemberResource {
  id              String             @id @default(cuid())
  title           String
  type            MemberResourceType @default(LINK)
  url             String?
  content         String?
  createdByUserId String
  createdAt       DateTime           @default(now())

  createdBy       User               @relation(fields: [createdByUserId], references: [id], onDelete: Restrict)

  @@index([createdByUserId])
  @@map("member_resources")
  @@schema("public")
}

model MemberAnnouncement {
  id        String   @id @default(cuid())
  title     String
  body      String
  createdAt DateTime @default(now())

  @@map("member_announcements")
  @@schema("public")
}

enum MemberSupportStatus {
  OPEN
  CLOSED

  @@schema("public")
}

enum MembershipStatus {
  ACTIVE
  TRIAL
  EXPIRED
  CANCELED

  @@schema("public")
}

model MemberSupportTicket {
  id        String              @id @default(cuid())
  userId    String
  subject   String
  message   String
  status    MemberSupportStatus @default(OPEN)
  createdAt DateTime            @default(now())

  user      User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("member_support_tickets")
  @@schema("public")
}

enum VerificationCodePurpose {
  ADMIN_LOGIN
  EMAIL_VERIFICATION
  PASSWORD_RESET
  
  @@schema("public")
}

model Course {
  id            String   @id @default(cuid())
  title         String
  slug          String   @unique
  description   String
  thumbnail     String?
  status        CourseStatus @default(DRAFT)
  price         Float    @default(0)
  duration      Int?     // in minutes
  level         CourseLevel @default(BEGINNER)
  instructorId  String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  publishedAt   DateTime?
  
  // Relations
  instructor    User     @relation("CourseInstructor", fields: [instructorId], references: [id], onDelete: Cascade)
  lessons       Lesson[]
  enrollments   Enrollment[]
  reviews       Review[]
  payments      Payment[]
  certificates  Certificate[]
  
  @@map("courses")
  @@schema("teachers")
}

model Lesson {
  id          String   @id @default(cuid())
  title       String
  description String?
  content     String
  videoUrl    String?
  duration    Int?     // in minutes
  order       Int
  courseId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  @@map("lessons")
  @@schema("teachers")
}

model Enrollment {
  id          String   @id @default(cuid())
  userId      String
  courseId    String
  status      EnrollmentStatus @default(ACTIVE)
  progress    Float    @default(0) // 0-100
  enrolledAt  DateTime @default(now())
  completedAt DateTime?
  
  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  @@unique([userId, courseId])
  @@map("enrollments")
  @@schema("students")
}

model Review {
  id          String   @id @default(cuid())
  rating      Int      // 1-5
  comment     String?
  userId      String
  courseId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  @@unique([userId, courseId])
  @@map("reviews")
  @@schema("students")
}

enum Role {
  STUDENT
  INSTRUCTOR
  ADMIN
  MEMBER
  
  @@schema("public")
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING
  
  @@schema("public")
}

enum CourseStatus {
  DRAFT
  REVIEW
  PUBLISHED
  ARCHIVED
  
  @@schema("public")
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  
  @@schema("public")
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  
  @@schema("public")
}

model Payment {
  id              String   @id @default(cuid())
  userId          String
  courseId        String
  amount          Float
  currency        String   @default("SAR")
  status          PaymentStatus @default(PENDING)
  paymentMethod   String?  // stripe, paypal, bank_transfer, etc.
  transactionId   String?  // external payment provider ID
  couponCode      String?
  discountAmount  Float    @default(0)
  
  // Customer info (for guests or record keeping)
  customerName    String?
  customerEmail   String?
  customerPhone   String?
  
  // Metadata
  notes           String?
  paidAt          DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course          Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  @@map("payments")
  @@schema("students")
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
  
  @@schema("public")
}

model TeacherApplication {
  id                String   @id @default(cuid())
  
  // Personal Information
  fullName          String
  email             String
  phone             String
  dateOfBirth       String?
  nationality       String?
  gender            String?
  
  // Education
  degree            String?
  fieldOfStudy      String?
  university        String?
  graduationYear    String?
  
  // Teaching Experience
  yearsExperience   String?
  subjectsToTeach   String
  quranMemorization String?
  tajweedLevel      String?
  onlineExperience  String?
  
  // Availability
  availableDays     String?
  hoursPerWeek      String?
  startDate         String?
  
  // Other
  motivation        String?
  expectedSalary    String?
  
  // Application Status
  status            ApplicationStatus @default(PENDING)
  reviewedBy        String?
  reviewedAt        DateTime?
  reviewNotes       String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("teacher_applications")
  @@schema("teachers")
}

enum ApplicationStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  
  @@schema("public")
}

model AuditLog {
  id            String   @id @default(cuid())
  actorUserId   String?
  action        String
  entityType    String?
  entityId      String?
  metadata      Json?
  createdAt     DateTime @default(now())
  
  // Relations
  actor         User?    @relation("AuditLogActor", fields: [actorUserId], references: [id], onDelete: SetNull)
  
  @@index([actorUserId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
  @@schema("admins")
}

model SystemSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       Json
  category    String   @default("general")
  description String?
  updatedAt   DateTime @updatedAt
  updatedBy   String?
  
  @@index([category])
  @@map("system_settings")
  @@schema("admins")
}

model Notification {
  id          String   @id @default(cuid())
  title       String
  content     String
  channel     NotificationChannel @default(EMAIL)
  status      NotificationStatus @default(DRAFT)
  targetType  NotificationTarget @default(ALL_USERS)
  scheduledAt DateTime?
  sentAt      DateTime?
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([status])
  @@index([channel])
  @@map("notifications")
  @@schema("admins")
}

enum NotificationChannel {
  EMAIL
  IN_APP
  SMS
  PUSH
  
  @@schema("public")
}

enum NotificationStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  FAILED
  
  @@schema("public")
}

enum NotificationTarget {
  ALL_USERS
  STUDENTS
  TEACHERS
  SPECIFIC_USERS
  
  @@schema("public")
}

// ==================== SOCIAL/POSTS SYSTEM ====================

model Post {
  id              String   @id @default(cuid())
  title           String?
  content         String   @db.Text // Rich text HTML content
  excerpt         String?  // Short preview text
  
  // Styling options (stored as JSON)
  styling         Json?    // { fontFamily, fontSize, fontColor, backgroundColor, textAlign, etc. }
  
  // Author info
  authorId        String
  authorType      AuthorType @default(ADMIN)
  
  // Status and visibility
  status          PostStatus @default(DRAFT)
  visibility      PostVisibility @default(PUBLIC)
  isPinned        Boolean  @default(false)
  allowComments   Boolean  @default(true)
  allowLikes      Boolean  @default(true)
  
  // Engagement counts (denormalized for performance)
  likesCount      Int      @default(0)
  commentsCount   Int      @default(0)
  viewsCount      Int      @default(0)
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  publishedAt     DateTime?
  
  // Relations
  media           PostMedia[]
  comments        PostComment[]
  likes           PostLike[]
  
  @@index([authorId])
  @@index([status])
  @@index([createdAt])
  @@index([isPinned, publishedAt])
  @@map("posts")
  @@schema("public")
}

model PostMedia {
  id          String   @id @default(cuid())
  postId      String
  
  // Media details
  type        MediaType
  url         String
  filename    String?
  mimeType    String?
  fileSize    Int?     // in bytes
  
  // Media dimensions/duration
  width       Int?
  height      Int?
  duration    Int?     // for audio/video in seconds
  
  // Display options
  caption     String?
  altText     String?
  order       Int      @default(0)
  styling     Json?    // { borderRadius, objectFit, aspectRatio, etc. }
  
  // Timestamps
  createdAt   DateTime @default(now())
  
  // Relations
  post        Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  @@index([postId])
  @@map("post_media")
  @@schema("public")
}

model PostComment {
  id          String   @id @default(cuid())
  postId      String
  authorId    String
  authorName  String   // Denormalized for display
  authorAvatar String?
  
  content     String   @db.Text
  
  // Nested comments support
  parentId    String?
  
  // Moderation
  status      CommentStatus @default(APPROVED)
  
  // Engagement
  likesCount  Int      @default(0)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  post        Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  parent      PostComment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies     PostComment[] @relation("CommentReplies")
  likes       CommentLike[]
  
  @@index([postId])
  @@index([authorId])
  @@index([parentId])
  @@map("post_comments")
  @@schema("public")
}

model PostLike {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())
  
  // Relations
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
  @@map("post_likes")
  @@schema("public")
}

model CommentLike {
  id        String   @id @default(cuid())
  commentId String
  userId    String
  createdAt DateTime @default(now())
  
  // Relations
  comment   PostComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  
  @@unique([commentId, userId])
  @@index([commentId])
  @@index([userId])
  @@map("comment_likes")
  @@schema("public")
}

enum AuthorType {
  ADMIN
  INSTRUCTOR
  MEMBER
  
  @@schema("public")
}

enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
  
  @@schema("public")
}

enum PostVisibility {
  PUBLIC
  TEACHERS_ONLY
  PRIVATE
  
  @@schema("public")
}

// ==========================================
// BLOG POSTS - For blog/article content
// ==========================================

model BlogPost {
  id            String   @id @default(cuid())
  title         String
  slug          String   @unique // URL-friendly slug
  content       String   @db.Text // Rich text HTML content
  excerpt       String?  // Short preview text
  
  // Styling options (stored as JSON)
  styling       Json?    // { fontFamily, fontSize, fontColor, backgroundColor, textAlign, etc. }
  
  // Author info
  authorId      String
  author        User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  // Status and visibility
  status        PostStatus @default(DRAFT)
  visibility    BlogVisibility @default(PUBLIC)
  featured      Boolean  @default(false)
  allowComments Boolean  @default(true)
  
  // Tags for categorization
  tags          String[] @default([])
  
  // Engagement counts (denormalized for performance)
  likesCount    Int      @default(0)
  commentsCount Int      @default(0)
  viewsCount    Int      @default(0)
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  publishedAt   DateTime?
  
  // Relations
  media         BlogPostMedia[]
  
  @@index([authorId])
  @@index([status])
  @@index([slug])
  @@index([featured])
  @@index([createdAt])
  @@map("blog_posts")
  @@schema("public")
}

model BlogPostMedia {
  id          String   @id @default(cuid())
  postId      String
  
  // Media details
  type        MediaType
  url         String
  filename    String?
  mimeType    String?
  fileSize    Int?     // in bytes
  
  // Media dimensions/duration
  width       Int?
  height      Int?
  duration    Int?     // for audio/video in seconds
  
  // Display options
  caption     String?
  altText     String?
  order       Int      @default(0)
  styling     Json?    // { borderRadius, objectFit, aspectRatio, etc. }
  
  // Timestamps
  createdAt   DateTime @default(now())
  
  // Relations
  post        BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  @@index([postId])
  @@map("blog_post_media")
  @@schema("public")
}

enum BlogVisibility {
  PUBLIC
  MEMBERS_ONLY
  PRIVATE
  
  @@schema("public")
}

enum MediaType {
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  PDF
  
  @@schema("public")
}

enum CommentStatus {
  PENDING
  APPROVED
  REJECTED
  SPAM
  
  @@schema("public")
}

model AdminRole {
  id          String   @id @default(cuid())
  name        String   @unique
  nameAr      String
  description String?
  permissions Json     // Array of permission strings
  isSystem    Boolean  @default(false) // System roles cannot be deleted
  status      String   @default("active") // active, inactive
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("admin_roles")
  @@schema("admins")
}

model Certificate {
  id                String   @id @default(cuid())
  certificateNumber String   @unique
  studentName       String
  studentNameEn     String?
  courseName        String
  courseNameEn      String?
  completionDate    DateTime
  grade             String?
  score             Float?
  instructorName    String?
  courseDuration    String?
  templateType      String   @default("classic")
  
  // Optional relations to actual user/course
  userId            String?
  courseId          String?
  
  // Metadata
  issuedBy          String?  // Admin who issued
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations (optional - certificates can exist without user/course records)
  user              User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  course            Course?  @relation(fields: [courseId], references: [id], onDelete: SetNull)
  
  @@index([studentName])
  @@index([courseName])
  @@index([certificateNumber])
  @@map("certificates")
  @@schema("students")
}

// ==========================================
// Teacher Room - Communication System
// ==========================================

model TeacherRoomMessage {
  id          String      @id @default(cuid())
  content     String?     // Text content (null for voice-only messages)
  type        MessageType @default(TEXT)
  voiceUrl    String?     // URL to voice message file
  voiceDuration Int?      // Duration in seconds
  attachmentUrl String?   // Optional file attachment
  attachmentName String?
  attachmentType String?
  
  // Author info
  authorId    String
  authorName  String
  authorAvatar String?
  authorRole  Role
  
  // Reply to another message
  replyToId   String?
  replyTo     TeacherRoomMessage? @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies     TeacherRoomMessage[] @relation("MessageReplies")
  
  // Reactions
  reactions   MessageReaction[]
  
  // Status
  isEdited    Boolean  @default(false)
  isDeleted   Boolean  @default(false)
  isPinned    Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([authorId])
  @@index([createdAt])
  @@map("teacher_room_messages")
  @@schema("teachers")
}

model MessageReaction {
  id        String   @id @default(cuid())
  emoji     String   // The emoji reaction
  userId    String
  userName  String
  messageId String
  message   TeacherRoomMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  
  @@unique([messageId, userId, emoji])
  @@map("message_reactions")
  @@schema("teachers")
}

model TeacherMeeting {
  id          String        @id @default(cuid())
  title       String
  description String?
  type        MeetingType   @default(VIDEO)
  status      MeetingStatus @default(SCHEDULED)
  
  // Scheduling
  scheduledAt DateTime?
  startedAt   DateTime?
  endedAt     DateTime?
  duration    Int?          // Duration in minutes
  
  // Host info
  hostId      String
  hostName    String
  hostAvatar  String?
  
  // Meeting settings
  isRecorded  Boolean @default(false)
  recordingUrl String?
  maxParticipants Int @default(50)
  
  // Privacy & Access Control
  privacy     MeetingPrivacy @default(PUBLIC)
  requireApproval Boolean @default(false) // Host must approve join requests
  allowChat   Boolean @default(true)
  allowScreenShare Boolean @default(true)
  allowHandRaise Boolean @default(true)
  
  // Notification settings
  notifyOnCreate Boolean @default(true)  // Send notifications when created
  notifyBeforeStart Int? // Minutes before start to send reminder
  
  // Participants
  participants MeetingParticipant[]
  
  // Invitations (for private meetings)
  invitations MeetingInvitation[]
  
  // Chat during meeting
  chatMessages MeetingChatMessage[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([hostId])
  @@index([status])
  @@index([scheduledAt])
  @@index([privacy])
  @@map("teacher_meetings")
  @@schema("teachers")
}

model MeetingInvitation {
  id          String   @id @default(cuid())
  meetingId   String
  meeting     TeacherMeeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  
  userId      String
  userName    String
  userEmail   String
  userRole    Role
  
  // Invitation status
  status      InvitationStatus @default(PENDING)
  respondedAt DateTime?
  
  // Notification tracking
  emailSent   Boolean @default(false)
  emailSentAt DateTime?
  notificationSent Boolean @default(false)
  
  createdAt   DateTime @default(now())
  
  @@unique([meetingId, userId])
  @@index([userId])
  @@index([status])
  @@map("meeting_invitations")
  @@schema("teachers")
}

// User notifications (in-app)
model UserNotification {
  id          String   @id @default(cuid())
  userId      String
  
  type        UserNotificationType
  title       String
  message     String
  link        String?  // URL to navigate to
  
  // Reference to related entity
  referenceType String? // "meeting", "post", etc.
  referenceId   String?
  
  isRead      Boolean @default(false)
  readAt      DateTime?
  
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("user_notifications")
  @@schema("public")
}

enum MeetingPrivacy {
  PUBLIC      // All teachers/admins can join
  PRIVATE     // Only invited users can join
  
  @@schema("public")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
  
  @@schema("public")
}

enum UserNotificationType {
  MEETING_INVITATION
  MEETING_STARTING
  MEETING_CANCELLED
  NEW_MESSAGE
  SYSTEM
  
  @@schema("public")
}

model MeetingParticipant {
  id          String   @id @default(cuid())
  meetingId   String
  meeting     TeacherMeeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  
  userId      String
  userName    String
  userAvatar  String?
  userRole    Role
  
  // Participant status
  joinedAt    DateTime?
  leftAt      DateTime?
  isActive    Boolean  @default(false)
  isMuted     Boolean  @default(false)
  isCameraOff Boolean  @default(false)
  isHandRaised Boolean @default(false)
  
  // Permissions
  canSpeak    Boolean  @default(true)
  canShare    Boolean  @default(false)
  isCoHost    Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([meetingId, userId])
  @@map("meeting_participants")
  @@schema("teachers")
}

model MeetingChatMessage {
  id          String   @id @default(cuid())
  meetingId   String
  meeting     TeacherMeeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  
  content     String
  authorId    String
  authorName  String
  authorAvatar String?
  
  createdAt   DateTime @default(now())
  
  @@index([meetingId])
  @@map("meeting_chat_messages")
  @@schema("teachers")
}

// ==========================================
// TEACHING SESSIONS (Teacher-to-Student Lessons)
// ==========================================

model TeachingSession {
  id          String   @id @default(cuid())
  
  title       String
  description String?
  type        MeetingType @default(VIDEO) // VIDEO or VOICE
  
  // Session timing
  status      MeetingStatus @default(SCHEDULED)
  scheduledAt DateTime?
  startedAt   DateTime?
  endedAt     DateTime?
  duration    Int?     // Duration in minutes
  
  // Teacher (host) info
  teacherId   String
  teacherName String
  teacherAvatar String?
  
  // Course/Subject association (optional)
  courseId    String?
  courseName  String?
  
  // Session settings
  isRecorded  Boolean @default(false)
  recordingUrl String?
  maxStudents Int @default(30)
  
  // Privacy & Access Control
  privacy     MeetingPrivacy @default(PRIVATE) // Default PRIVATE for lessons
  requireApproval Boolean @default(false)
  allowChat   Boolean @default(true)
  allowScreenShare Boolean @default(true)
  allowHandRaise Boolean @default(true)
  allowStudentMic Boolean @default(false) // Can students unmute?
  allowStudentCamera Boolean @default(false) // Can students turn on camera?
  
  // Notification settings
  notifyOnCreate Boolean @default(true)
  notifyBeforeStart Int? // Minutes before start
  
  // Relations
  participants SessionParticipant[]
  invitations  SessionInvitation[]
  chatMessages SessionChatMessage[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([teacherId])
  @@index([status])
  @@index([scheduledAt])
  @@index([courseId])
  @@map("teaching_sessions")
  @@schema("teachers")
}

model SessionParticipant {
  id          String   @id @default(cuid())
  sessionId   String
  session     TeachingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  userId      String
  userName    String
  userAvatar  String?
  userRole    Role     // STUDENT, INSTRUCTOR, ADMIN
  
  // Status
  isActive    Boolean @default(false)
  joinedAt    DateTime?
  leftAt      DateTime?
  
  // Permissions (can be overridden by teacher)
  isMuted     Boolean @default(true)
  isCameraOff Boolean @default(true)
  isHandRaised Boolean @default(false)
  canSpeak    Boolean @default(false)
  canShare    Boolean @default(false)
  
  createdAt   DateTime @default(now())
  
  @@unique([sessionId, userId])
  @@index([userId])
  @@map("session_participants")
  @@schema("teachers")
}

model SessionInvitation {
  id          String   @id @default(cuid())
  sessionId   String
  session     TeachingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  userId      String
  userName    String
  userEmail   String
  userRole    Role
  
  // Invitation status
  status      InvitationStatus @default(PENDING)
  respondedAt DateTime?
  
  // Notification tracking
  emailSent   Boolean @default(false)
  emailSentAt DateTime?
  notificationSent Boolean @default(false)
  
  createdAt   DateTime @default(now())
  
  @@unique([sessionId, userId])
  @@index([userId])
  @@index([status])
  @@map("session_invitations")
  @@schema("teachers")
}

model SessionChatMessage {
  id          String   @id @default(cuid())
  sessionId   String
  session     TeachingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  content     String
  authorId    String
  authorName  String
  authorAvatar String?
  authorRole  Role
  
  createdAt   DateTime @default(now())
  
  @@index([sessionId])
  @@map("session_chat_messages")
  @@schema("teachers")
}

enum MessageType {
  TEXT
  VOICE
  FILE
  SYSTEM
  
  @@schema("public")
}

enum MeetingType {
  VIDEO
  VOICE
  
  @@schema("public")
}

enum MeetingStatus {
  SCHEDULED
  LIVE
  ENDED
  CANCELLED
  
  @@schema("public")
}

// ==========================================
// AI AGENT SYSTEM
// ==========================================

model AgentSession {
  id          String   @id @default(cuid())
  userId      String?
  userRole    Role?
  locale      String   @default("ar")
  
  // Session data
  context     Json?    // Current context (courseId, lessonId, etc.)
  preferences Json?    // User preferences for this session
  
  // Conversation
  messageCount Int     @default(0)
  
  // Timestamps
  startedAt   DateTime @default(now())
  lastActiveAt DateTime @default(now())
  expiresAt   DateTime
  
  // Relations
  messages    AgentMessage[]
  
  @@index([userId])
  @@index([expiresAt])
  @@map("agent_sessions")
  @@schema("ai")
}

model AgentMessage {
  id          String   @id @default(cuid())
  sessionId   String
  session     AgentSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  role        AgentMessageRole
  content     String   @db.Text
  
  // For tool calls
  toolName    String?
  toolInput   Json?
  toolOutput  Json?
  
  // Metadata
  tokenCount  Int?
  durationMs  Int?
  cached      Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  
  @@index([sessionId])
  @@map("agent_messages")
  @@schema("ai")
}

model AgentPromptTemplate {
  id          String   @id @default(cuid())
  name        String
  templateId  String   // Logical ID (e.g., "system_prompt")
  version     Int      @default(1)
  locale      String   @default("ar")
  
  template    String   @db.Text
  variables   String[] @default([])
  
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  
  @@unique([templateId, version, locale])
  @@index([templateId, isActive])
  @@map("agent_prompt_templates")
  @@schema("ai")
}

enum AgentMessageRole {
  SYSTEM
  USER
  ASSISTANT
  TOOL
  
  @@schema("ai")
}

